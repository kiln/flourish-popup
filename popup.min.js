(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?module.exports=e():typeof define==="function"&&define.amd?define(e):t.Popup=e()})(this,function(){"use strict";var t="0.1-dev";var e=0;var i=25;var n=5;var o=10;var r=10;var p=["bottom","top","left","right","topLeft","bottomLeft","topRight","bottomRight","bottomFlexible","topFlexible","leftFlexible","rightFlexible"];function h(){this.unique_id=e++;this._container=document.body;this._maxWidth="70%";this._point=null;this._html=null;this._directions=p;this._fallbackFit="horizontal";this.handlers={click:[]}}function l(t,e){if(e.length>0&&e.charAt(0)=="_"){t[e.substr(1)]=function(t){if(typeof t=="undefined")return this[e];this[e]=t;return this}}}for(var a in new h("*")){l(h.prototype,a)}h.prototype.point=function(t,e){if(typeof t=="undefined")return this._point;if(typeof e!="undefined")this._point=[t,e];else if(t instanceof HTMLElement||t instanceof SVGElement){var i=t.getBoundingClientRect();this._point=[Math.floor(i.left+i.width/2),Math.floor(i.top+i.height/2)]}else{console.error("Kiln.popup: could not understand argument")}return this};function s(t){return t.replace(/[&<>]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;"}[t]})}h.prototype.text=function t(e){this._html=s(e);return this};h.prototype.on=function t(e,i){if(!(e in this.handlers))throw"Kiln.popup.on: No such event: "+e;this.handlers[e].push(i);return this};h.prototype.fire=function t(e,i){if(!(e in this.handlers))throw"Kiln.popup.fire: No such event: "+e;var n=this.handlers[e];for(var o=0;o<n.length;o++){n[o](i)}return this};function u(t,e,i){var n=document.createElementNS("http://www.w3.org/2000/svg",t);var o;if(e)for(o in e)n.setAttribute(o,e[o]);var r=n.style;if(i)for(o in i)r[o]=i[o];return n}h.prototype._getElement=function t(){var e=this;var o="kiln-popup-"+this.unique_id;var r=document.getElementById(o);if(!r){r=document.createElement("div");r.className="kiln-popup";r.id=o;var p=r.style;p.display="none";p.margin=p.padding=0;p.position="absolute";p.width="80px";p.height="40px";p.boxSizing="border-box";r.addEventListener("click",function(){e.fire("click",e)},false);var h=u("svg",{class:"kiln-popup-svg"},{position:"absolute",top:0,left:0,bottom:0,right:0});var l=u("filter",{id:"dropshadow-"+this.unique_id,height:"130%"});l.appendChild(u("feGaussianBlur",{in:"SourceAlpha",stdDeviation:5}));l.appendChild(u("feOffset",{dx:0,dy:2,result:"offsetblur"}));var a=u("feComponentTransfer");a.appendChild(u("feFuncA",{type:"linear",slope:.2}));l.appendChild(a);var s=u("feMerge");l.appendChild(s);s.appendChild(u("feMergeNode"));s.appendChild(u("feMergeNode",{in:"SourceGraphic"}));h.appendChild(l);var f=u("g",{filter:"url(#dropshadow-"+this.unique_id+")",fill:"white",stroke:"none"});f.appendChild(u("rect",{x:i,y:i,rx:n}));f.appendChild(u("path"));h.appendChild(f);r.appendChild(h);var d=document.createElement("div");d.className="kiln-popup-content";p=d.style;p.position="absolute";p.top=p.left=i+"px";p.padding="10px";r.appendChild(d);document.body.appendChild(r)}return r};var f={};f.bottom=function t(e,i){return{shape:[-o,-r,o,-r],pos:[e/2,i+r]}};f.top=function t(e,i){return{shape:[-o,r,o,r],pos:[e/2,-r]}};f.left=function t(e,i){return{shape:[r,o,r,-o],pos:[-r,i/2]}};f.right=function t(e,i){return{shape:[-r,o,-r,-o],pos:[e+r,i/2]}};f.topLeft=function t(e,i){return{shape:[r+n,r,r,r+n],pos:[-r,-r]}};f.bottomLeft=function t(e,i){return{shape:[r+n,-r,r,-r-n],pos:[-r,i+r]}};f.topRight=function t(e,i){return{shape:[-r-n,r,-r,r+n],pos:[e+r,-r]}};f.bottomRight=function t(e,i){return{shape:[-r-n,-r,-r,-r-n],pos:[e+r,i+r]}};function d(t,e,i,p,h,l,a){var s=i-t/2-r,u=i+t/2+r,f=t/2+Math.min(0,s-h.left)+Math.max(0,u-h.right),d;if(f-o<n){d=[-f,(-r-n)*l,Math.max(o,n-f),-r*l]}else if(f+o>t-n){d=[Math.min(-o,t-f-n),-r*l,Math.min(o,t-f),(-r-n)*l]}else{d=[-o,-r*l,o,-r*l]}return{pos:[f,a],shape:d}}function c(t,e,i,p,h,l,a){var s=p-e/2-r,u=p+e/2+r,f=e/2+Math.min(0,s-h.top)+Math.max(0,u-h.bottom),d;if(f-o<n){d=[(-r-n)*l,-f,-r*l,Math.max(o,n-f)]}else if(f+o>e-n){d=[-r*l,Math.min(-o,e-f-n),(-r-n)*l,Math.min(o,e-f)]}else{d=[-r*l,-o,-r*l,o]}return{pos:[a,f],shape:d}}f.bottomFlexible=function t(e,i,n,o,p){return d(e,i,n,o,p,+1,i+r)};f.topFlexible=function t(e,i,n,o,p){return d(e,i,n,o,p,-1,-r)};f.rightFlexible=function t(e,i,n,o,p){return c(e,i,n,o,p,+1,e+r)};f.leftFlexible=function t(e,i,n,o,p){return c(e,i,n,o,p,-1,-r)};function m(t,e,n,o,r,p){var h=f[t](e,n,o,r,p),l=o-i-h.pos[0],a=r-i-h.pos[1];return{left:l,top:a,right:l+e+2*i,bottom:a+n+2*i}}function g(t,e,n,o,r,p,h,l,a,s){var u=f[t](o,r,l,a,s);e.left=p-i-u.pos[0]+"px";e.top=h-i-u.pos[1]+"px";n.setAttribute("d","M0,0L"+u.shape.join(",")+"Z");n.setAttribute("transform","translate("+(u.pos[0]+i)+","+(u.pos[1]+i)+")")}h.prototype.__maxContentWidth=function t(e){if(this._maxWidth.match(/^\d+(?:\.\d+)?%$/)){return e.width*parseFloat(this._maxWidth)/100}if(this._maxWidth.match(/^\d+(?:\.\d+)?(?:px)?$/)){return parseFloat(this._maxWidth)}if(this._maxWidth!=null){console.error("Kiln.popup: Unknown value for maxWidth: "+this._maxWidth)}return e.width};h.prototype.draw=function t(){if(!this._point){console.error("Kiln.popup: cannot draw popup till point() has been specified");return}var e=document.documentElement.getBoundingClientRect(),n=this._point[0],o=this._point[1],p=this._container.getBoundingClientRect();if(n<p.left)n=p.left;else if(n>p.right)n=p.right;if(o<p.top)o=p.top;else if(o>p.bottom)o=p.bottom;var h=n-e.left,l=o-e.top;var a=this._getElement(),s=a.style,u=a.querySelector(".kiln-popup-svg"),f=u.querySelector("g"),d=f.querySelector("rect"),c=f.querySelector("path"),v=a.querySelector(".kiln-popup-content");s.display="block";v.style.maxWidth=this.__maxContentWidth(p)+"px";v.innerHTML=this._html;var b=v.getBoundingClientRect(),x,_;do{x=Math.ceil(b.width);_=Math.ceil(b.height);s.width=x+2*i+"px";s.height=_+2*i+"px";b=v.getBoundingClientRect()}while(x!=Math.ceil(b.width)||_!=Math.ceil(b.height));d.setAttribute("width",x);d.setAttribute("height",_);u.setAttribute("width",x+2*i);u.setAttribute("height",_+2*i);var y=i-r;var M=null,w=null,C=null,k=Infinity,F=Infinity,E,W;for(var A=0;A<this._directions.length;A++){var S=this._directions[A],q=m(S,x,_,n,o,p),R=Math.max(0,Math.floor(p.left)-q.left-y)+Math.max(0,q.right-Math.ceil(p.right)-y),L=Math.max(0,Math.floor(p.top)-q.top-y)+Math.max(0,q.bottom-Math.ceil(p.bottom)-y);if(R==0&&L==0){M=S;break}if(R<k||R==k&&L<E){k=R;E=L;w=S}if(L<F||L==F&&R<W){F=L;W=R;C=S}}if(M){S=M}else if(this._fallbackFit=="horizontal"){S=w}else if(this._fallbackFit=="vertical"){S=C}else{console.warn("Kiln.popup: failed to point box of size ("+x+", "+_+")"+" at ("+n+", "+o+") within ("+p.left+", "+p.top+", "+p.right+", "+p.bottom+")");S=this._directions[0]}g(S,s,c,x,_,h,l,n,o,p);return this};h.prototype.hide=function t(){this._getElement().style.display="none";return this};function v(){return new h}v.version=t;return v});