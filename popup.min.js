(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?module.exports=e():typeof define==="function"&&define.amd?define(e):t.Popup=e()})(this,function(){"use strict";var t="1.1.1";var e=0;var i=25;var n=5;var o=10;var r=10;var h=["bottom","top","left","right","topLeft","bottomLeft","topRight","bottomRight","bottomFlexible","topFlexible","leftFlexible","rightFlexible"];function p(){this.unique_id=e++;this._container=document.body;this._maxWidth="70%";this._point=null;this._html=null;this._directions=h;this._fallbackFit="horizontal";this.handlers={click:[]}}function a(t,e){if(e.length>0&&e.charAt(0)=="_"){t[e.substr(1)]=function(t){if(typeof t=="undefined")return this[e];this[e]=t;return this}}}for(var l in new p("*")){a(p.prototype,l)}p.prototype.point=function(t,e){if(typeof t=="undefined")return this._point;if(typeof e!="undefined")this._point=[t,e];else if(t instanceof HTMLElement||t instanceof SVGElement){var i=t.getBoundingClientRect();this._point=[Math.floor(i.left+i.width/2),Math.floor(i.top+i.height/2)]}else{console.error("Popup: could not understand argument")}return this};function s(t){return t.replace(/[&<>]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;"}[t]})}p.prototype.text=function t(e){this._html=s(e);return this};p.prototype.on=function t(e,i){if(!(e in this.handlers))throw new Error("Popup.on: No such event: "+e);this.handlers[e].push(i);return this};p.prototype.fire=function t(e,i){if(!(e in this.handlers))throw new Error("Popup.fire: No such event: "+e);var n=this.handlers[e];for(var o=0;o<n.length;o++){n[o].call(this,i)}return this};function u(t,e,i){var n=document.createElementNS("http://www.w3.org/2000/svg",t);var o;if(e)for(o in e)n.setAttribute(o,e[o]);var r=n.style;if(i)for(o in i)r[o]=i[o];return n}p.prototype._getElement=function t(){var e=this;var o="flourish-popup-"+this.unique_id;var r=document.getElementById(o);if(!r){r=document.createElement("div");r.className="flourish-popup";r.id=o;var h=r.style;h.display="none";h.margin=h.padding=0;h.position="absolute";h.width="80px";h.height="40px";h.boxSizing="border-box";r.addEventListener("click",function(t){e.fire("click",t)},false);var p=u("svg",{class:"flourish-popup-svg"},{position:"absolute",top:0,left:0,bottom:0,right:0});var a=u("filter",{id:"dropshadow-"+this.unique_id,height:"130%"});a.appendChild(u("feGaussianBlur",{in:"SourceAlpha",stdDeviation:5}));a.appendChild(u("feOffset",{dx:0,dy:2,result:"offsetblur"}));var l=u("feComponentTransfer");l.appendChild(u("feFuncA",{type:"linear",slope:.2}));a.appendChild(l);var s=u("feMerge");a.appendChild(s);s.appendChild(u("feMergeNode"));s.appendChild(u("feMergeNode",{in:"SourceGraphic"}));p.appendChild(a);var f=u("g",{filter:"url(#dropshadow-"+this.unique_id+")",fill:"white",stroke:"none"});f.appendChild(u("rect",{x:i,y:i,rx:n}));f.appendChild(u("path"));p.appendChild(f);r.appendChild(p);var d=document.createElement("div");d.className="flourish-popup-content";h=d.style;h.position="absolute";h.top=h.left=i+"px";h.padding="10px";r.appendChild(d);document.body.appendChild(r)}return r};var f={};f.bottom=function t(e,i){return{shape:[-o,-r,o,-r],pos:[e/2,i+r]}};f.top=function t(e,i){return{shape:[-o,r,o,r],pos:[e/2,-r]}};f.left=function t(e,i){return{shape:[r,o,r,-o],pos:[-r,i/2]}};f.right=function t(e,i){return{shape:[-r,o,-r,-o],pos:[e+r,i/2]}};f.topLeft=function t(e,i){return{shape:[r+n,r,r,r+n],pos:[-r,-r]}};f.bottomLeft=function t(e,i){return{shape:[r+n,-r,r,-r-n],pos:[-r,i+r]}};f.topRight=function t(e,i){return{shape:[-r-n,r,-r,r+n],pos:[e+r,-r]}};f.bottomRight=function t(e,i){return{shape:[-r-n,-r,-r,-r-n],pos:[e+r,i+r]}};function d(t,e,i,h,p,a,l){var s=i-t/2-r,u=i+t/2+r,f=t/2+Math.min(0,s-p.left)+Math.max(0,u-p.right),d;if(f-o<n){d=[-f,(-r-n)*a,Math.max(o,n-f),-r*a]}else if(f+o>t-n){d=[Math.min(-o,t-f-n),-r*a,Math.min(o,t-f),(-r-n)*a]}else{d=[-o,-r*a,o,-r*a]}return{pos:[f,l],shape:d}}function c(t,e,i,h,p,a,l){var s=h-e/2-r,u=h+e/2+r,f=e/2+Math.min(0,s-p.top)+Math.max(0,u-p.bottom),d;if(f-o<n){d=[(-r-n)*a,-f,-r*a,Math.max(o,n-f)]}else if(f+o>e-n){d=[-r*a,Math.min(-o,e-f-n),(-r-n)*a,Math.min(o,e-f)]}else{d=[-r*a,-o,-r*a,o]}return{pos:[l,f],shape:d}}f.bottomFlexible=function t(e,i,n,o,h){return d(e,i,n,o,h,+1,i+r)};f.topFlexible=function t(e,i,n,o,h){return d(e,i,n,o,h,-1,-r)};f.rightFlexible=function t(e,i,n,o,h){return c(e,i,n,o,h,+1,e+r)};f.leftFlexible=function t(e,i,n,o,h){return c(e,i,n,o,h,-1,-r)};function m(t,e,n,o,r,h){var p=f[t](e,n,o,r,h),a=o-i-p.pos[0],l=r-i-p.pos[1];return{left:a,top:l,right:a+e+2*i,bottom:l+n+2*i}}function g(t,e,n,o,r,h,p,a,l,s){var u=f[t](o,r,a,l,s);e.left=h-i-u.pos[0]+"px";e.top=p-i-u.pos[1]+"px";n.setAttribute("d","M0,0L"+u.shape.join(",")+"Z");n.setAttribute("transform","translate("+(u.pos[0]+i)+","+(u.pos[1]+i)+")")}p.prototype.__maxContentWidth=function t(e){if(this._maxWidth.match(/^\d+(?:\.\d+)?%$/)){return e.width*parseFloat(this._maxWidth)/100}if(this._maxWidth.match(/^\d+(?:\.\d+)?(?:px)?$/)){return parseFloat(this._maxWidth)}if(this._maxWidth!=null){console.error("Popup: Unknown value for maxWidth: "+this._maxWidth)}return e.width};p.prototype.draw=function t(){if(!this._point){console.error("Popup: cannot draw popup till point() has been specified");return}var e=document.documentElement.getBoundingClientRect(),n=this._point[0],o=this._point[1],h=this._container.getBoundingClientRect();if(n<h.left)n=h.left;else if(n>h.right)n=h.right;if(o<h.top)o=h.top;else if(o>h.bottom)o=h.bottom;var p=n-e.left,a=o-e.top;var l=this._getElement(),s=l.style,u=l.querySelector(".flourish-popup-svg"),f=u.querySelector("g"),d=f.querySelector("rect"),c=f.querySelector("path"),v=l.querySelector(".flourish-popup-content");s.display="block";v.style.maxWidth=this.__maxContentWidth(h)+"px";v.innerHTML=this._html;var b=v.getBoundingClientRect(),x,_;do{x=Math.ceil(b.width);_=Math.ceil(b.height);s.width=x+2*i+"px";s.height=_+2*i+"px";b=v.getBoundingClientRect()}while(x!=Math.ceil(b.width)||_!=Math.ceil(b.height));d.setAttribute("width",x);d.setAttribute("height",_);u.setAttribute("width",x+2*i);u.setAttribute("height",_+2*i);var y=i-r;var M=null,w=null,C=null,F=Infinity,E=Infinity,W,k;for(var A=0;A<this._directions.length;A++){var S=this._directions[A],q=m(S,x,_,n,o,h),R=Math.max(0,Math.floor(h.left)-q.left-y)+Math.max(0,q.right-Math.ceil(h.right)-y),L=Math.max(0,Math.floor(h.top)-q.top-y)+Math.max(0,q.bottom-Math.ceil(h.bottom)-y);if(R==0&&L==0){M=S;break}if(R<F||R==F&&L<W){F=R;W=L;w=S}if(L<E||L==E&&R<k){E=L;k=R;C=S}}if(M){S=M}else if(this._fallbackFit=="horizontal"){S=w}else if(this._fallbackFit=="vertical"){S=C}else{console.warn("Popup: failed to point box of size ("+x+", "+_+")"+" at ("+n+", "+o+") within ("+h.left+", "+h.top+", "+h.right+", "+h.bottom+")");S=this._directions[0]}g(S,s,c,x,_,p,a,n,o,h);return this};p.prototype.hide=function t(){this._getElement().style.display="none";return this};function v(){return new p}v.version=t;return v});